<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Processing System - AI Powered</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --bg-card: rgba(20, 20, 20, 0.95);
            --border-primary: #333333;
            --border-secondary: #404040;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-muted: #666666;
            --accent-blue: #2563eb;
            --accent-purple: #7c3aed;
            --accent-green: #059669;
            --accent-red: #dc2626;
            --accent-orange: #ea580c;
            --accent-yellow: #f59e0b;
            --gradient-primary: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            --gradient-accent: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            --shadow-primary: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-elevated: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-glow: 0 0 0 1px rgba(37, 99, 235, 0.1), 0 0 20px rgba(37, 99, 235, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(37, 99, 235, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(124, 58, 237, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(5, 150, 105, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1400px;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 3rem 0 2rem;
        }

        .header h1 {
            font-size: 2.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
            letter-spacing: -0.025em;
        }

        .header .subtitle {
            font-size: 1.125rem;
            color: var(--text-secondary);
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto;
        }

        .card-dark {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            box-shadow: var(--shadow-primary);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-dark:hover {
            border-color: var(--border-secondary);
            box-shadow: var(--shadow-elevated);
        }

        /* Navigation Tabs */
        .nav-tabs-dark {
            border-bottom: 2px solid var(--border-primary);
            margin-bottom: 2rem;
        }

        .nav-tabs-dark .nav-link {
            color: var(--text-secondary);
            background: transparent;
            border: none;
            border-radius: 8px 8px 0 0;
            padding: 1rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tabs-dark .nav-link:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .nav-tabs-dark .nav-link.active {
            color: var(--accent-blue);
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--accent-blue);
        }

        .nav-tabs-dark .nav-link i {
            margin-right: 0.5rem;
        }

        /* Tab Content */
        .tab-content {
            min-height: 600px;
        }

        .upload-section, .batch-section, .features-section {
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .upload-area, .batch-upload-area {
            border: 2px dashed var(--border-primary);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: var(--bg-secondary);
            position: relative;
            overflow: hidden;
        }

        .upload-area::before, .batch-upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(37, 99, 235, 0.1), transparent);
            transition: left 0.8s;
        }

        .upload-area:hover::before, .batch-upload-area:hover::before {
            left: 100%;
        }

        .upload-area:hover, .batch-upload-area:hover {
            border-color: var(--accent-blue);
            background: rgba(37, 99, 235, 0.05);
            transform: translateY(-2px);
        }

        .upload-area.dragover, .batch-upload-area.dragover {
            border-color: var(--accent-blue);
            background: rgba(37, 99, 235, 0.1);
            box-shadow: var(--shadow-glow);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        .upload-area:hover .upload-icon, .batch-upload-area:hover .upload-icon {
            color: var(--accent-blue);
            transform: scale(1.1);
        }

        .upload-text {
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .file-input {
            display: none;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-primary);
        }

        .process-btn, .query-btn, .batch-process-btn, .export-btn {
            background: var(--gradient-accent);
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            margin-top: 1.5rem;
            margin-right: 1rem;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-primary);
            position: relative;
            overflow: hidden;
        }

        .export-btn {
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-blue) 100%);
        }

        .batch-process-btn {
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-orange) 100%);
        }

        .process-btn::before, .query-btn::before, .batch-process-btn::before, .export-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .process-btn:hover::before, .query-btn:hover::before, .batch-process-btn:hover::before, .export-btn:hover::before {
            left: 100%;
        }

        .process-btn:hover, .query-btn:hover, .batch-process-btn:hover, .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-elevated);
        }

        .process-btn:disabled, .query-btn:disabled, .batch-process-btn:disabled, .export-btn:disabled {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Features List */
        .features-list {
            list-style: none;
            padding: 0;
        }

        .features-list li {
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 4px solid var(--accent-blue);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .features-list li i {
            color: var(--accent-blue);
            margin-top: 0.2rem;
            font-size: 1.2rem;
        }

        .feature-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .feature-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* File List */
        .file-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 1rem;
            background: var(--bg-secondary);
            margin-top: 1rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        .file-item:last-child {
            margin-bottom: 0;
        }

        .file-info-item {
            flex: 1;
        }

        .file-name {
            color: var(--text-primary);
            font-weight: 500;
        }

        .file-size {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .remove-file {
            background: var(--accent-red);
            border: none;
            color: white;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
        }

        /* Progress Bar */
        .progress-container {
            margin-top: 1rem;
            display: none;
        }

        .progress {
            height: 20px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar {
            background: var(--gradient-accent);
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        /* Batch Results */
        .batch-results {
            display: none;
            margin-top: 2rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .result-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 1rem;
        }

        .result-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .status-success {
            background: rgba(5, 150, 105, 0.2);
            color: var(--accent-green);
        }

        .status-error {
            background: rgba(220, 38, 38, 0.2);
            color: var(--accent-red);
        }

        .status-processing {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-yellow);
        }

        /* Export Options */
        .export-options {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-primary);
        }

        .form-check-dark {
            margin-bottom: 0.5rem;
        }

        .form-check-input:checked {
            background-color: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        .form-check-label {
            color: var(--text-secondary);
            margin-left: 0.5rem;
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-primary);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Results Section */
        .results-section {
            display: none;
            animation: fadeInUp 0.6s ease;
        }

        .results-section.show {
            display: block;
        }

        .query-section {
            display: none;
            animation: fadeInUp 0.6s ease;
            margin-bottom: 2rem;
        }

        .query-section.show {
            display: block;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .preview-card, .data-card, .query-card {
            height: 650px;
            margin-bottom: 2rem;
        }

        .query-input-card {
            height: auto;
            margin-bottom: 2rem;
        }

        .card-header-dark {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            gap: 10px;
            border-radius: 12px 12px 0 0;
        }

        .card-body-dark {
            padding: 1.5rem;
            height: calc(100% - 60px);
            overflow-y: auto;
            background: var(--bg-secondary);
            border-radius: 0 0 12px 12px;
        }

        .query-input-body {
            padding: 1.5rem;
            background: var(--bg-secondary);
            border-radius: 0 0 12px 12px;
        }

        .preview-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
        }

        .preview-img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
            box-shadow: var(--shadow-primary);
            transition: transform 0.3s ease;
        }

        .preview-img:hover {
            transform: scale(1.02);
        }

        .json-output {
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 1.5rem;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            white-space: pre-wrap;
            height: 100%;
            margin: 0;
            overflow-y: auto;
            border: 1px solid var(--border-primary);
        }

        .query-response {
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 1.5rem;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            line-height: 1.6;
            height: 100%;
            margin: 0;
            overflow-y: auto;
            border: 1px solid var(--border-primary);
        }

        .loading-spinner, .batch-loading {
            display: none;
            text-align: center;
            color: var(--text-secondary);
            margin-top: 2rem;
        }

        .query-loading {
            display: none;
            text-align: center;
            color: var(--text-secondary);
            margin-top: 1rem;
        }

        .spinner {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-primary);
            border-radius: 50%;
            border-top-color: var(--accent-blue);
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        .spinner-small {
            width: 20px;
            height: 20px;
            border-width: 2px;
            margin-bottom: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-alert, .success-alert, .info-alert {
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }

        .error-alert {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.3);
            color: #fca5a5;
        }

        .success-alert {
            background: rgba(5, 150, 105, 0.1);
            border: 1px solid rgba(5, 150, 105, 0.3);
            color: #6ee7b7;
        }

        .info-alert {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #93c5fd;
        }

        .form-control-dark, .form-select-dark {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .form-control-dark:focus, .form-select-dark:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25);
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .form-control-dark::placeholder {
            color: var(--text-muted);
        }

        .form-select-dark option {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .form-label {
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .badge {
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-ocr {
            background-color: var(--accent-green) !important;
        }

        .example-queries {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .example-query {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-primary);
        }

        .example-query:hover {
            background: var(--accent-blue);
            color: white;
            transform: translateY(-1px);
        }

        .confidence-indicator {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            margin-left: 0.5rem;
            font-weight: 600;
        }

        .confidence-high {
            background: rgba(5, 150, 105, 0.2);
            color: var(--accent-green);
        }

        .confidence-medium {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-yellow);
        }

        .confidence-low {
            background: rgba(220, 38, 38, 0.2);
            color: var(--accent-red);
        }

        .extracted-fields {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            border: 1px solid var(--border-primary);
        }

        .response-section {
            padding: 1rem 0;
        }

        .response-answer {
            margin-bottom: 1rem;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-secondary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .upload-area, .batch-upload-area {
                padding: 2rem 1rem;
            }
            
            .upload-icon {
                font-size: 2.5rem;
            }
            
            .preview-card, .data-card, .query-card {
                height: 450px;
                margin-bottom: 1rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .example-queries {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="header">
            <h1><i class="fas fa-file-invoice"></i> Invoice Processing System</h1>
            <p class="subtitle">AI-powered document analysis with intelligent querying and batch processing capabilities</p>
        </div>
        
        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs nav-tabs-dark" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="features-tab" data-bs-toggle="tab" data-bs-target="#features" type="button" role="tab" aria-controls="features" aria-selected="true">
                    <i class="fas fa-list-check"></i> Features & Overview
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="single-tab" data-bs-toggle="tab" data-bs-target="#single" type="button" role="tab" aria-controls="single" aria-selected="false">
                    <i class="fas fa-file"></i> Single File Processing
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="batch-tab" data-bs-toggle="tab" data-bs-target="#batch" type="button" role="tab" aria-controls="batch" aria-selected="false">
                    <i class="fas fa-files"></i> Batch Processing
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabContent">
            
            <!-- Features & Overview Tab -->
            <div class="tab-pane fade show active" id="features" role="tabpanel" aria-labelledby="features-tab">
                <div class="card-dark features-section">
                    <h2 class="mb-4"><i class="fas fa-cogs"></i> Current Features & Processing Capabilities</h2>
                    
                    <!-- Statistics -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalProcessed">0</div>
                            <div class="stat-label">Files Processed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="successRate">100%</div>
                            <div class="stat-label">Success Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalInvoices">0</div>
                            <div class="stat-label">Invoices Extracted</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="avgProcessingTime">0s</div>
                            <div class="stat-label">Avg Processing Time</div>
                        </div>
                    </div>

                    <ul class="features-list">
                        <li>
                            <i class="fas fa-file-excel"></i>
                            <div>
                                <div class="feature-title">Excel Export</div>
                                <div class="feature-description">Export processed invoice data to Excel format with customizable field selection, including header information and line items.</div>
                            </div>
                        </li>
                        <li>
                            <i class="fas fa-layer-group"></i>
                            <div>
                                <div class="feature-title">Multi-Invoice File Processing</div>
                                <div class="feature-description">Automatically detect and process multiple invoices within a single PDF file, breaking them down with serial numbering for comprehensive data extraction.</div>
                            </div>
                        </li>
                        <li>
                            <i class="fas fa-database"></i>
                            <div>
                                <div class="feature-title">Structured Data Extraction</div>
                                <div class="feature-description">Extract key invoice fields including ABN, dates, invoice numbers, vendor information, line items, tax amounts, and totals in structured JSON format.</div>
                            </div>
                        </li>
                        <li>
                            <i class="fas fa-eye"></i>
                            <div>
                                <div class="feature-title">Document Preview</div>
                                <div class="feature-description">Visual preview of processed PDF documents with zoom and navigation capabilities for verification and quality assurance.</div>
                            </div>
                        </li>
                        <li>
                            <i class="fas fa-chart-line"></i>
                            <div>
                                <div class="feature-title">Performance Monitoring</div>
                                <div class="feature-description">Real-time statistics tracking including processing times, success rates, and system resource utilization.</div>
                            </div>
                        </li>
                        <li>
                            <i class="fas fa-shield-alt"></i>
                            <div>
                                <div class="feature-title">Security & Compliance</div>
                                <div class="feature-description">Secure file handling with automatic cleanup, rate limiting, and comprehensive error handling for enterprise-grade reliability.</div>
                            </div>
                        </li>
                        <li>        
                            <i class="fas fa-brain"></i>
                            <div>
                                <div class="feature-title">AI-Powered Text Extraction</div>
                                <div class="feature-description">Multiple OCR engines including PyMuPDF, PDFPlumber, PDFMiner, and Tesseract OCR with automatic fallback for optimal text extraction from PDF invoices.</div>
                            </div>
                        </li>
                        <li>
                            <i class="fas fa-robot"></i>
                            <div>
                                <div class="feature-title">Advanced LLM Processing</div>
                                <div class="feature-description">Support for multiple language models including Mistral Large, Llama 3.1-3.3, Grok 3-4, Cohere Command R+, and Llama Vision for structured data extraction.</div>
                            </div>
                        </li>
                        <li>
                            <i class="fas fa-search"></i>
                            <div>
                                <div class="feature-title">Intelligent Querying</div>
                                <div class="feature-description">Ask natural language questions about processed invoices and get accurate AI-powered responses with confidence indicators.</div>
                            </div>
                        </li>
                        <li>
                            <i class="fas fa-files"></i>
                            <div>
                                <div class="feature-title">Batch Processing</div>
                                <div class="feature-description">Process multiple PDF files simultaneously with progress tracking and individual result management for high-volume invoice processing.</div>
                            </div>
                        </li>
                    </ul>

                    <div class="mt-4">
                        <h4><i class="fas fa-info-circle text-info"></i> Processing Workflow</h4>
                        <ol class="text-secondary mt-3" style="line-height: 2;">
                            <li><strong>File Upload:</strong> Secure PDF upload with validation and size limits</li>
                            <li><strong>OCR Processing:</strong> Intelligent text extraction using selected OCR engine</li>
                            <li><strong>AI Analysis:</strong> LLM-powered structured data extraction and validation</li>
                            <li><strong>Data Storage:</strong> Temporary storage of extracted data for querying</li>
                            <li><strong>User Interaction:</strong> Natural language querying and data export</li>
                            <li><strong>Cleanup:</strong> Automatic file cleanup and resource management</li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- Single File Processing Tab -->
            <div class="tab-pane fade" id="single" role="tabpanel" aria-labelledby="single-tab">
                <!-- Upload Section -->
                <div class="card-dark upload-section">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="llmSelect" class="form-label text-light mb-2">
                                    <i class="fas fa-brain"></i> Select AI Model
                                </label>
                                <select class="form-select form-select-dark" id="llmSelect">
                                    <option value="mistral">Mistral Large (Latest)</option>
                                    <option value="llama-3.1">Llama 3.1 (70B)</option>
                                    <option value="llama-3.2">Llama 3.2 (90B)</option>
                                    <option value="llama-3.3">Llama 3.3 (70B)</option>
                                    <option value="llama-vision">Llama Vision (11B)</option>
                                    <option value="grok-3">Grok 3 (314B)</option>
                                    <option value="grok-4">Grok 4 (405B)</option>
                                    <option value="cohere">Cohere Command R+</option>
                                </select>
                                <div class="model-info text-muted mt-1">Choose the AI model for data extraction</div>
                            </div>

                            <div class="col-md-6">
                                <label for="ocrSelect" class="form-label text-light mb-2">
                                    <i class="fas fa-eye"></i> Select OCR Engine
                                </label>
                                <select class="form-select form-select-dark" id="ocrSelect">
                                    <option value="auto">Auto (Best Available)</option>
                                    <option value="pymupdf">PyMuPDF (Fast)</option>
                                    <option value="pdfplumber">PDFPlumber (Structured)</option>
                                    <option value="pdfminer">PDFMiner (Text-focused)</option>
                                    <option value="tesseract">Tesseract OCR (Image-based)</option>
                                    <option value="tesseract_enhanced">Tesseract Enhanced (High Quality)</option>
                                </select>
                                <div class="model-info text-muted mt-1">Choose the OCR method for text extraction</div>
                            </div>
                        </div>

                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">
                                <i class="fas fa-upload"></i>
                            </div>
                            <div class="upload-text">Drop PDF file here or click to select</div>
                            <div class="upload-subtext">Maximum file size: 16MB • Supported format: PDF</div>
                            <input class="file-input" type="file" id="invoiceFile" accept=".pdf" required>
                        </div>
                        
                        <div class="file-info" id="fileInfo" style="display: none;">
                            <i class="fas fa-file-pdf text-danger"></i>
                            <span id="fileName"></span>
                            <span class="ms-auto text-muted" id="fileSize"></span>
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="process-btn" id="processBtn" disabled>
                                <i class="fas fa-cog"></i> Process Document
                            </button>
                        </div>
                        
                        <div class="loading-spinner" id="loadingSpinner">
                            <div class="spinner"></div>
                            <div>Analyzing document structure and extracting data...</div>
                        </div>
                        
                        <div class="error-alert" id="errorAlert">
                            <i class="fas fa-exclamation-circle"></i>
                            <span id="errorMessage"></span>
                        </div>
                        
                        <div class="success-alert" id="successAlert">
                            <i class="fas fa-check-circle"></i>
                            Document processed successfully. Data extraction complete.
                        </div>
                    </form>
                </div>

                <!-- Query Section -->
                <div class="query-section" id="querySection">
                    <div class="card-dark query-input-card">
                        <div class="card-header-dark">
                            <i class="fas fa-question-circle"></i>
                            Ask Questions About Your Invoice
                            <div class="ms-auto">
                                <select class="form-select form-select-dark" id="queryLlmSelect" style="width: auto; font-size: 0.8rem;">
                                    <option value="mistral">Mistral Large</option>
                                    <option value="llama-3.1">Llama 3.1</option>
                                    <option value="llama-3.2">Llama 3.2</option>
                                    <option value="llama-3.3">Llama 3.3</option>
                                    <option value="grok-3">Grok 3</option>
                                    <option value="grok-4">Grok 4</option>
                                    <option value="cohere">Cohere</option>
                                </select>
                            </div>
                        </div>
                        <div class="query-input-body">
                            <div class="mb-3">
                                <label for="queryInput" class="form-label">
                                    <i class="fas fa-comment-dots"></i> Your Question
                                </label>
                                <textarea 
                                    class="form-control form-control-dark" 
                                    id="queryInput" 
                                    rows="3" 
                                    placeholder="Ask anything about the invoice... e.g., 'What is the invoice number?', 'Who is the vendor?', 'What is the total amount?'"
                                ></textarea>
                            </div>
                            
                            <div class="query-examples">
                                <label class="form-label text-muted mb-2">Quick Examples:</label>
                                <div class="example-queries">
                                    <span class="example-query" data-query="What is the invoice number?">Invoice Number</span>
                                    <span class="example-query" data-query="What is the total amount?">Total Amount</span>
                                    <span class="example-query" data-query="Who is the vendor or supplier?">Vendor Name</span>
                                    <span class="example-query" data-query="What is the invoice date?">Invoice Date</span>
                                    <span class="example-query" data-query="What are the line items?">Line Items</span>
                                    <span class="example-query" data-query="What is the due date for payment?">Due Date</span>
                                    <span class="example-query" data-query="What is the tax amount?">Tax Amount</span>
                                    <span class="example-query" data-query="What is the PO number?">PO Number</span>
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <button type="button" class="query-btn" id="queryBtn" disabled>
                                    <i class="fas fa-search"></i> Ask Question
                                </button>
                            </div>
                            
                            <div class="query-loading" id="queryLoading">
                                <div class="spinner spinner-small"></div>
                                <div>Processing your question...</div>
                            </div>
                            
                            <div class="info-alert" id="queryInfoAlert">
                                <i class="fas fa-info-circle"></i>
                                <span id="queryInfoMessage"></span>
                            </div>
                            
                            <div class="error-alert" id="queryErrorAlert">
                                <i class="fas fa-exclamation-circle"></i>
                                <span id="queryErrorMessage"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="results-section" id="resultsSection">
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="card-dark preview-card">
                                <div class="card-header-dark">
                                    <i class="fas fa-image"></i>
                                    Document Preview
                                </div>
                                <div class="card-body-dark">
                                    <div class="preview-container" id="previewContainer">
                                        <div class="text-center">
                                            <i class="fas fa-file-pdf fa-3x mb-3" style="opacity: 0.3;"></i>
                                            <p class="text-muted">Document preview will appear here</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-4">
                            <div class="card-dark data-card">
                                <div class="card-header-dark">
                                    <i class="fas fa-database"></i>
                                    Extracted Data
                                    <span class="badge bg-info ms-2" id="llmBadge" style="display: none;">LLM: Mistral</span>
                                    <span class="badge badge-ocr ms-2" id="ocrBadge" style="display: none;">OCR: Auto</span>
                                    <div class="ms-auto">
                                        <button class="btn btn-sm btn-outline-light" id="copyBtn" title="Copy JSON">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body-dark">
                                    <pre class="json-output" id="jsonOutput">// No data processed yet
// Upload a PDF invoice to see extracted structured data</pre>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="card-dark query-card">
                                <div class="card-header-dark">
                                    <i class="fas fa-comments"></i>
                                    AI Responses
                                    <span class="badge bg-success ms-2" id="queryLlmBadge" style="display: none;">LLM: Mistral</span>
                                </div>
                                <div class="card-body-dark">
                                    <div class="query-response" id="queryResponse">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-robot fa-3x mb-3" style="opacity: 0.3;"></i>
                                            <p>Ask questions about your invoice to get AI-powered answers</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Batch Processing Tab -->
            <div class="tab-pane fade" id="batch" role="tabpanel" aria-labelledby="batch-tab">
                <div class="card-dark batch-section">
                    <h3 class="mb-4"><i class="fas fa-files"></i> Batch Processing</h3>
                    
                    <form id="batchUploadForm" enctype="multipart/form-data">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label for="batchLlmSelect" class="form-label text-light mb-2">
                                    <i class="fas fa-brain"></i> Batch AI Model
                                </label>
                                <select class="form-select form-select-dark" id="batchLlmSelect">
                                    <option value="mistral">Mistral Large (Latest)</option>
                                    <option value="llama-3.1">Llama 3.1 (70B)</option>
                                    <option value="llama-3.2">Llama 3.2 (90B)</option>
                                    <option value="llama-3.3">Llama 3.3 (70B)</option>
                                    <option value="cohere">Cohere Command R+</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="batchOcrSelect" class="form-label text-light mb-2">
                                    <i class="fas fa-eye"></i> Batch OCR Engine
                                </label>
                                <select class="form-select form-select-dark" id="batchOcrSelect">
                                    <option value="auto">Auto (Best Available)</option>
                                    <option value="pymupdf">PyMuPDF (Fast)</option>
                                    <option value="pdfplumber">PDFPlumber (Structured)</option>
                                    <option value="tesseract">Tesseract OCR</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="splitMode" class="form-label text-light mb-2">
                                    <i class="fas fa-layer-group"></i> Processing Mode
                                </label>
                                <select class="form-select form-select-dark" id="splitMode">
                                    <option value="single">Single Invoice per File</option>
                                    <option value="multi">Multiple Invoices per File</option>
                                    <option value="auto">Auto-detect</option>
                                </select>
                            </div>
                        </div>

                        <div class="batch-upload-area" id="batchUploadArea">
                            <div class="upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="upload-text">Drop multiple PDF files here or click to select</div>
                            <div class="upload-subtext">Maximum 50 files • 16MB per file • Supports multi-invoice detection</div>
                            <input class="file-input" type="file" id="batchFiles" accept=".pdf" multiple required>
                        </div>

                        <div class="file-list" id="batchFileList" style="display: none;">
                            <h5><i class="fas fa-list"></i> Selected Files (<span id="fileCount">0</span>)</h5>
                            <div id="fileListContainer"></div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="batch-process-btn" id="batchProcessBtn" disabled>
                                <i class="fas fa-rocket"></i> Process Batch
                            </button>
                            <button type="button" class="export-btn" id="exportBtn" disabled>
                                <i class="fas fa-file-excel"></i> Export to Excel
                            </button>
                        </div>

                        <!-- Export Options -->
                        <div class="export-options" id="exportOptions">
                            <h5><i class="fas fa-cog"></i> Export Settings</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check form-check-dark">
                                        <input class="form-check-input" type="checkbox" id="exportHeaders" checked>
                                        <label class="form-check-label" for="exportHeaders">Include Header Fields</label>
                                    </div>
                                    <div class="form-check form-check-dark">
                                        <input class="form-check-input" type="checkbox" id="exportLineItems" checked>
                                        <label class="form-check-label" for="exportLineItems">Include Line Items</label>
                                    </div>
                                    <div class="form-check form-check-dark">
                                        <input class="form-check-input" type="checkbox" id="exportMetadata" checked>
                                        <label class="form-check-label" for="exportMetadata">Include Processing Metadata</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-check-dark">
                                        <input class="form-check-input" type="checkbox" id="separateSheets">
                                        <label class="form-check-label" for="separateSheets">Separate Sheets per File</label>
                                    </div>
                                    <div class="form-check form-check-dark">
                                        <input class="form-check-input" type="checkbox" id="includeConfidence" checked>
                                        <label class="form-check-label" for="includeConfidence">Include Confidence Scores</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="progress-container" id="progressContainer">
                            <div class="progress">
                                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                            </div>
                            <div class="progress-text" id="progressText">Ready to process...</div>
                        </div>

                        <div class="batch-loading" id="batchLoading">
                            <div class="spinner"></div>
                            <div>Processing batch files...</div>
                        </div>

                        <div class="error-alert" id="batchErrorAlert">
                            <i class="fas fa-exclamation-circle"></i>
                            <span id="batchErrorMessage"></span>
                        </div>

                        <div class="success-alert" id="batchSuccessAlert">
                            <i class="fas fa-check-circle"></i>
                            <span id="batchSuccessMessage"></span>
                        </div>
                    </form>
                </div>

                <!-- Batch Results -->
                <div class="batch-results" id="batchResults">
                    <div class="card-dark">
                        <div class="card-header-dark">
                            <i class="fas fa-chart-bar"></i>
                            Batch Processing Results
                            <div class="ms-auto">
                                <button class="btn btn-sm btn-outline-light" id="clearResults" title="Clear Results">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body-dark">
                            <div class="results-grid" id="resultsGrid">
                                <!-- Results will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let isDocumentProcessed = false;
        let currentQueryLLM = 'mistral';
        let batchResults = [];
        let processedFiles = 0;
        let totalInvoices = 0;
        let averageProcessingTime = 0;
        let successfulProcesses = 0;

        // DOM elements - Single file processing
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('invoiceFile');
        const llmSelect = document.getElementById('llmSelect');
        const ocrSelect = document.getElementById('ocrSelect');
        const queryLlmSelect = document.getElementById('queryLlmSelect');
        const processBtn = document.getElementById('processBtn');
        const queryBtn = document.getElementById('queryBtn');
        const queryInput = document.getElementById('queryInput');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const queryLoading = document.getElementById('queryLoading');
        const errorAlert = document.getElementById('errorAlert');
        const successAlert = document.getElementById('successAlert');
        const queryErrorAlert = document.getElementById('queryErrorAlert');
        const queryInfoAlert = document.getElementById('queryInfoAlert');
        const resultsSection = document.getElementById('resultsSection');
        const querySection = document.getElementById('querySection');
        const previewContainer = document.getElementById('previewContainer');
        const jsonOutput = document.getElementById('jsonOutput');
        const queryResponse = document.getElementById('queryResponse');

        // DOM elements - Batch processing
        const batchUploadArea = document.getElementById('batchUploadArea');
        const batchFilesInput = document.getElementById('batchFiles');
        const batchLlmSelect = document.getElementById('batchLlmSelect');
        const batchOcrSelect = document.getElementById('batchOcrSelect');
        const splitMode = document.getElementById('splitMode');
        const batchFileList = document.getElementById('batchFileList');
        const fileListContainer = document.getElementById('fileListContainer');
        const fileCount = document.getElementById('fileCount');
        const batchProcessBtn = document.getElementById('batchProcessBtn');
        const exportBtn = document.getElementById('exportBtn');
        const exportOptions = document.getElementById('exportOptions');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const batchLoading = document.getElementById('batchLoading');
        const batchErrorAlert = document.getElementById('batchErrorAlert');
        const batchSuccessAlert = document.getElementById('batchSuccessAlert');
        const batchResultsDiv = document.getElementById('batchResults');
        const resultsGrid = document.getElementById('resultsGrid');

        // Statistics elements
        const totalProcessedStat = document.getElementById('totalProcessed');
        const successRateStat = document.getElementById('successRate');
        const totalInvoicesStat = document.getElementById('totalInvoices');
        const avgProcessingTimeStat = document.getElementById('avgProcessingTime');

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            updateStatistics();
            checkHealth();
        });

        function initializeEventListeners() {
            // Single file upload listeners
            setupSingleFileListeners();
            
            // Batch processing listeners
            setupBatchProcessingListeners();
            
            // Export listeners
            setupExportListeners();
            
            // Query listeners  
            setupQueryListeners();
        }

        function setupSingleFileListeners() {
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'application/pdf') {
                    fileInput.files = files;
                    handleFileSelection(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelection(e.target.files[0]);
                }
            });

            document.getElementById('uploadForm').addEventListener('submit', handleSingleFileSubmission);
        }

        function setupBatchProcessingListeners() {
            batchUploadArea.addEventListener('click', () => batchFilesInput.click());
            
            batchUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                batchUploadArea.classList.add('dragover');
            });
            
            batchUploadArea.addEventListener('dragleave', () => {
                batchUploadArea.classList.remove('dragover');
            });
            
            batchUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                batchUploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
                if (files.length > 0) {
                    const dt = new DataTransfer();
                    files.forEach(file => dt.items.add(file));
                    batchFilesInput.files = dt.files;
                    handleBatchFileSelection(files);
                }
            });

            batchFilesInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleBatchFileSelection(Array.from(e.target.files));
                }
            });

            document.getElementById('batchUploadForm').addEventListener('submit', handleBatchSubmission);
            document.getElementById('clearResults').addEventListener('click', clearBatchResults);
        }

        function setupExportListeners() {
            exportBtn.addEventListener('click', () => {
                if (exportOptions.style.display === 'none' || !exportOptions.style.display) {
                    exportOptions.style.display = 'block';
                } else {
                    exportToExcel();
                }
            });

            // Export format selection and processing
            document.getElementById('exportHeaders').addEventListener('change', updateExportPreview);
            document.getElementById('exportLineItems').addEventListener('change', updateExportPreview);
        }

        function setupQueryListeners() {
            queryBtn.addEventListener('click', handleQuery);
            queryInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    handleQuery();
                }
            });

            queryInput.addEventListener('input', () => {
                queryBtn.disabled = !queryInput.value.trim() || !isDocumentProcessed;
            });

            queryLlmSelect.addEventListener('change', (e) => {
                currentQueryLLM = e.target.value;
            });

            // Example query handlers
            document.querySelectorAll('.example-query').forEach(example => {
                example.addEventListener('click', () => {
                    queryInput.value = example.dataset.query;
                    queryBtn.disabled = !isDocumentProcessed;
                });
            });
        }

        function handleFileSelection(file) {
            const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = `${sizeInMB} MB`;
            document.getElementById('fileInfo').style.display = 'flex';
            processBtn.disabled = false;
            
            // Reset states
            isDocumentProcessed = false;
            queryBtn.disabled = true;
            querySection.classList.remove('show');
            resultsSection.classList.remove('show');
            hideAlerts();
        }

        function handleBatchFileSelection(files) {
            fileCount.textContent = files.length;
            fileListContainer.innerHTML = '';
            
            files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info-item">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${(file.size / (1024 * 1024)).toFixed(2)} MB</div>
                    </div>
                    <button type="button" class="remove-file" data-index="${index}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                fileListContainer.appendChild(fileItem);
            });

            // Add remove file functionality
            document.querySelectorAll('.remove-file').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('button').dataset.index);
                    removeFileFromBatch(index);
                });
            });

            batchFileList.style.display = files.length > 0 ? 'block' : 'none';
            batchProcessBtn.disabled = files.length === 0;
        }

        function removeFileFromBatch(index) {
            const dt = new DataTransfer();
            const files = Array.from(batchFilesInput.files);
            files.splice(index, 1);
            files.forEach(file => dt.items.add(file));
            batchFilesInput.files = dt.files;
            handleBatchFileSelection(files);
        }

        async function handleSingleFileSubmission(e) {
            e.preventDefault();
            const file = fileInput.files[0];
            
            if (!file) return;
            
            showLoading();
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('llm_model', llmSelect.value);
            formData.append('ocr_model', ocrSelect.value);
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.error || result.status === 'error') {
                    throw new Error(result.error || 'Processing failed');
                }
                
                // Display preview
                previewContainer.innerHTML = `
                    <img src="data:image/png;base64,${result.preview}" 
                         class="preview-img" 
                         alt="PDF Preview">
                `;
                
                // Display structured data
                jsonOutput.textContent = JSON.stringify(result.json_data, null, 2);
                
                // Update badges
                if (result.ocr_method) {
                    document.getElementById('ocrBadge').textContent = `OCR: ${result.ocr_method}`;
                    document.getElementById('ocrBadge').style.display = 'inline-block';
                }
                
                if (result.llm_used) {
                    document.getElementById('llmBadge').textContent = `LLM: ${result.llm_used}`;
                    document.getElementById('llmBadge').style.display = 'inline-block';
                }
                
                // Enable querying
                isDocumentProcessed = true;
                queryBtn.disabled = !queryInput.value.trim();
                
                // Show sections
                resultsSection.classList.add('show');
                querySection.classList.add('show');
                showSuccess();
                
                // Update statistics
                processedFiles++;
                successfulProcesses++;
                if (result.processing_time) {
                    averageProcessingTime = ((averageProcessingTime * (processedFiles - 1)) + parseFloat(result.processing_time)) / processedFiles;
                }
                updateStatistics();
                
                // Smooth scroll to results
                setTimeout(() => {
                    resultsSection.scrollIntoView({ behavior: 'smooth' });
                }, 300);
                
            } catch (error) {
                showError(error.message);
                console.error('Document processing error:', error);
                isDocumentProcessed = false;
                queryBtn.disabled = true;
            } finally {
                hideLoading();
            }
        }

        async function handleBatchSubmission(e) {
            e.preventDefault();
            const files = Array.from(batchFilesInput.files);
            
            if (files.length === 0) return;
            
            showBatchLoading();
            progressContainer.style.display = 'block';
            
            const results = [];
            let processed = 0;
            
            try {
                for (const file of files) {
                    progressText.textContent = `Processing ${file.name}... (${processed + 1}/${files.length})`;
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('llm_model', batchLlmSelect.value);
                    formData.append('ocr_model', batchOcrSelect.value);
                    formData.append('split_mode', splitMode.value);
                    
                    try {
                        const response = await fetch('/batch-upload', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (result.error) {
                            throw new Error(result.error);
                        }
                        
                        // Handle batch processing results which may contain multiple invoices
                        if (result.invoices_processed && Array.isArray(result.invoices_processed)) {
                            // Multiple invoices found in file
                            result.invoices_processed.forEach((invoice, idx) => {
                                results.push({
                                    filename: `${file.name} (Invoice ${invoice.invoice_number || idx + 1})`,
                                    status: invoice.status || 'success',
                                    data: invoice.data || {},
                                    invoices_found: 1,
                                    processing_time: result.processing_time,
                                    ocr_method: result.ocr_method,
                                    llm_used: result.llm_used,
                                    error: invoice.error
                                });
                            });
                            totalInvoices += result.invoices_processed.length;
                        } else {
                            // Single invoice or legacy format
                            results.push({
                                filename: file.name,
                                status: 'success',
                                data: result.json_data || {},
                                invoices_found: result.invoices_found || 1,
                                processing_time: result.processing_time,
                                ocr_method: result.ocr_method,
                                llm_used: result.llm_used
                            });
                            totalInvoices += result.invoices_found || 1;
                        }
                        
                        successfulProcesses++;
                        
                    } catch (error) {
                        results.push({
                            filename: file.name,
                            status: 'error',
                            error: error.message
                        });
                    }
                    
                    processed++;
                    const progress = (processed / files.length) * 100;
                    progressBar.style.width = `${progress}%`;
                    
                    // Add small delay to show progress
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Store results globally for export
                batchResults = batchResults.concat(results);
                
                // Display results
                displayBatchResults(results);
                
                const successfulCount = results.filter(r => r.status === 'success').length;
                showBatchSuccess(`Successfully processed ${processed} files with ${successfulCount} successful extractions.`);
                
                // Enable export
                exportBtn.disabled = false;
                
                // Update statistics
                processedFiles += files.length;
                updateStatistics();
                
            } catch (error) {
                showBatchError(error.message);
            } finally {
                hideBatchLoading();
                progressText.textContent = 'Processing complete';
            }
        }

        function displayBatchResults(results) {
            resultsGrid.innerHTML = '';
            
            results.forEach((result, index) => {
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';
                
                const statusClass = result.status === 'success' ? 'status-success' : 'status-error';
                const statusIcon = result.status === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
                
                resultCard.innerHTML = `
                    <div class="result-status ${statusClass}">
                        <i class="fas ${statusIcon}"></i> ${result.status.toUpperCase()}
                    </div>
                    <h6>${result.filename}</h6>
                    ${result.status === 'success' ? `
                        <div class="text-muted small mb-2">
                            <i class="fas fa-file-invoice"></i> ${result.invoices_found} invoice(s) found<br>
                            <i class="fas fa-clock"></i> ${result.processing_time}s<br>
                            <i class="fas fa-brain"></i> ${result.llm_used}<br>
                            <i class="fas fa-eye"></i> ${result.ocr_method}
                        </div>
                        <button class="btn btn-sm btn-outline-light view-data-btn" data-index="${batchResults.length - results.length + index}">
                            <i class="fas fa-eye"></i> View Data
                        </button>
                    ` : `
                        <div class="text-danger small">
                            <i class="fas fa-exclamation-circle"></i> ${result.error}
                        </div>
                    `}
                `;
                
                resultsGrid.appendChild(resultCard);
            });
            
            // Add view data event listeners
            document.querySelectorAll('.view-data-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('button').dataset.index);
                    viewResultData(batchResults[index]);
                });
            });
            
            batchResultsDiv.style.display = 'block';
        }

        function viewResultData(result) {
            // Create modal to show detailed data
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content bg-dark text-light">
                        <div class="modal-header border-secondary">
                            <h5 class="modal-title"><i class="fas fa-file-alt"></i> ${result.filename}</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <pre class="json-output" style="max-height: 500px; overflow-y: auto;">${JSON.stringify(result.data, null, 2)}</pre>
                        </div>
                        <div class="modal-footer border-secondary">
                            <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary copy-modal-data">
                                <i class="fas fa-copy"></i> Copy Data
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            
            // Copy functionality
            modal.querySelector('.copy-modal-data').addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(JSON.stringify(result.data, null, 2));
                    const btn = modal.querySelector('.copy-modal-data');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy:', err);
                }
            });
            
            // Clean up modal when closed
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
            
            bsModal.show();
        }

        async function handleQuery() {
            const query = queryInput.value.trim();
            if (!query || !isDocumentProcessed) return;

            showQueryLoading();
            
            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: query,
                        llm_model: currentQueryLLM
                    })
                });

                const result = await response.json();

                if (result.error || result.status === 'error') {
                    throw new Error(result.error || 'Query processing failed');
                }

                // Display the response
                displayQueryResponse(result.response, result.llm_used);
                
                // Show success info
                showQueryInfo('Query processed successfully');
                
            } catch (error) {
                showQueryError(error.message);
                console.error('Query processing error:', error);
                
                // Display error in response area
                queryResponse.innerHTML = `
                    <div class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3" style="opacity: 0.7;"></i>
                        <p><strong>Error processing query:</strong></p>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                hideQueryLoading();
            }
        }

        function displayQueryResponse(response, llmUsed) {
            const llmNames = {
                'mistral': 'Mistral Large',
                'llama-3.1': 'Llama 3.1',
                'llama-3.2': 'Llama 3.2', 
                'llama-3.3': 'Llama 3.3',
                'grok-3': 'Grok 3',
                'grok-4': 'Grok 4',
                'cohere': 'Cohere Command R+'
            };

            // Update LLM badge
            document.getElementById('queryLlmBadge').textContent = `LLM: ${llmNames[llmUsed] || llmUsed}`;
            document.getElementById('queryLlmBadge').style.display = 'inline-block';

            // Create response HTML
            let responseHTML = '';
            
            if (response && response.answer) {
                const confidenceClass = `confidence-${response.confidence || 'medium'}`;
                responseHTML += `
                    <div class="response-section">
                        <div class="response-answer">
                            <strong>Answer:</strong>
                            <span class="confidence-indicator ${confidenceClass}">
                                ${(response.confidence || 'medium').toUpperCase()}
                            </span>
                            <div class="mt-2">${response.answer}</div>
                        </div>
                `;

                if (response.extracted_fields && Object.keys(response.extracted_fields).length > 0) {
                    responseHTML += `
                        <div class="mb-3">
                            <strong>Extracted Fields:</strong>
                            <div class="extracted-fields mt-2">${JSON.stringify(response.extracted_fields, null, 2)}</div>
                        </div>
                    `;
                }

                responseHTML += `
                        <div class="text-muted" style="font-size: 0.8rem;">
                            <i class="fas fa-info-circle"></i> 
                            Data Found: ${response.data_found ? 'Yes' : 'No'} | 
                            Confidence: ${response.confidence || 'Medium'}
                        </div>
                    </div>
                `;
            } else {
                responseHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3" style="opacity: 0.5;"></i>
                        <p>No response generated. Please try a different question.</p>
                    </div>
                `;
            }

            queryResponse.innerHTML = responseHTML;
        }

        async function exportToExcel() {
            if (batchResults.length === 0) {
                showBatchError('No data to export. Please process some files first.');
                return;
            }

            const exportSettings = {
                includeHeaders: document.getElementById('exportHeaders').checked,
                includeLineItems: document.getElementById('exportLineItems').checked,
                includeMetadata: document.getElementById('exportMetadata').checked,
                separateSheets: document.getElementById('separateSheets').checked,
                includeConfidence: document.getElementById('includeConfidence').checked
            };

            try {
                const response = await fetch('/export-excel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        data: batchResults,
                        settings: exportSettings
                    })
                });

                if (!response.ok) {
                    throw new Error('Export failed');
                }

                // Download the file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `invoice_batch_export_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showBatchSuccess('Excel file exported successfully!');
                exportOptions.style.display = 'none';

            } catch (error) {
                showBatchError(`Export failed: ${error.message}`);
            }
        }

        function updateExportPreview() {
            // Update export preview based on selected options
            // This could show a preview of what will be exported
        }

        function clearBatchResults() {
            batchResults.length = 0;
            resultsGrid.innerHTML = '';
            batchResultsDiv.style.display = 'none';
            exportBtn.disabled = true;
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
            progressText.textContent = 'Ready to process...';
            hideBatchAlerts();
        }

        function updateStatistics() {
            totalProcessedStat.textContent = processedFiles;
            totalInvoicesStat.textContent = totalInvoices;
            
            const successRate = processedFiles > 0 ? Math.round((successfulProcesses / processedFiles) * 100) : 100;
            successRateStat.textContent = `${successRate}%`;
            
            avgProcessingTimeStat.textContent = `${averageProcessingTime.toFixed(1)}s`;
        }

        // Utility functions for UI feedback
        function showLoading() {
            processBtn.disabled = true;
            loadingSpinner.style.display = 'block';
            hideAlerts();
        }

        function hideLoading() {
            processBtn.disabled = false;
            loadingSpinner.style.display = 'none';
        }

        function showBatchLoading() {
            batchProcessBtn.disabled = true;
            batchLoading.style.display = 'block';
            hideBatchAlerts();
        }

        function hideBatchLoading() {
            batchProcessBtn.disabled = false;
            batchLoading.style.display = 'none';
        }

        function showQueryLoading() {
            queryBtn.disabled = true;
            queryLoading.style.display = 'block';
            hideQueryAlerts();
        }

        function hideQueryLoading() {
            queryBtn.disabled = !queryInput.value.trim() || !isDocumentProcessed;
            queryLoading.style.display = 'none';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            errorAlert.style.display = 'block';
            successAlert.style.display = 'none';
        }

        function showSuccess() {
            successAlert.style.display = 'block';
            errorAlert.style.display = 'none';
        }

        function showBatchError(message) {
            document.getElementById('batchErrorMessage').textContent = message;
            batchErrorAlert.style.display = 'block';
            batchSuccessAlert.style.display = 'none';
        }

        function showBatchSuccess(message) {
            document.getElementById('batchSuccessMessage').textContent = message;
            batchSuccessAlert.style.display = 'block';
            batchErrorAlert.style.display = 'none';
        }

        function showQueryError(message) {
            document.getElementById('queryErrorMessage').textContent = message;
            queryErrorAlert.style.display = 'block';
            queryInfoAlert.style.display = 'none';
        }

        function showQueryInfo(message) {
            document.getElementById('queryInfoMessage').textContent = message;
            queryInfoAlert.style.display = 'block';
            queryErrorAlert.style.display = 'none';
        }

        function hideAlerts() {
            errorAlert.style.display = 'none';
            successAlert.style.display = 'none';
        }

        function hideBatchAlerts() {
            batchErrorAlert.style.display = 'none';
            batchSuccessAlert.style.display = 'none';
        }

        function hideQueryAlerts() {
            queryErrorAlert.style.display = 'none';
            queryInfoAlert.style.display = 'none';
        }

        // Copy functionality
        document.getElementById('copyBtn')?.addEventListener('click', async () => {
            try {
                const textContent = jsonOutput.textContent || jsonOutput.innerText;
                await navigator.clipboard.writeText(textContent);
                const originalIcon = document.getElementById('copyBtn').innerHTML;
                document.getElementById('copyBtn').innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    document.getElementById('copyBtn').innerHTML = originalIcon;
                }, 2000);
            } catch (err) {
                console.error('Failed to copy: ', err);
            }
        });

        // Health check
        async function checkHealth() {
            try {
                const response = await fetch('/health');
                const result = await response.json();
                console.log('System status:', result);
                
                // Update statistics with health data if available
                if (result.stats) {
                    if (result.stats.batch_stats) {
                        totalProcessedStat.textContent = result.stats.batch_stats.total_files_processed || 0;
                        totalInvoicesStat.textContent = result.stats.batch_stats.total_invoices_extracted || 0;
                    }
                }
            } catch (error) {
                console.warn('Health check failed:', error);
            }
        }

        // Periodic health check to update statistics
        setInterval(checkHealth, 30000); // Every 30 seconds
    </script>
</body>
</html>            
                        
                        
                            
